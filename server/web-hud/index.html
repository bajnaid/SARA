<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SARA HUD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #05060a;
      --bg-alt: #0c0f18;
      --bg-elevated: #101320;
      --fg: #f5f7ff;
      --fg-muted: #9aa2c0;
      --accent: #4f8cff;
      --accent-soft: rgba(79, 140, 255, 0.14);
      --border-subtle: #202436;
      --danger: #ff4760;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-pill: 999px;
      --shadow-soft: 0 20px 45px rgba(0, 0, 0, 0.45);
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Helvetica Neue", sans-serif;
    }

    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #15192a 0, #05060a 45%, #000 100%);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    body.light {
      --bg: #f5f7ff;
      --bg-alt: #eef1ff;
      --bg-elevated: #ffffff;
      --fg: #070816;
      --fg-muted: #6c708b;
      --accent-soft: rgba(79, 140, 255, 0.12);
      --border-subtle: #d2d6f0;
      background: radial-gradient(circle at top, #ffffff 0, #eef1ff 40%, #e2e6ff 100%);
    }

    .shell {
      width: 100%;
      max-width: 1200px;
      padding: 20px 24px 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .identity {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-pill {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: radial-gradient(circle at 20% 0, #7be3ff, #4f8cff 40%, #914bff 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    .identity-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .identity-title {
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 11px;
      color: var(--fg-muted);
    }
    .identity-name {
      font-size: 14px;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    button, .btn {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: linear-gradient(135deg, #141827, #0b0e19);
      color: var(--fg);
      font-size: 13px;
      padding: 7px 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.35);
      transition: background 0.13s ease, transform 0.12s ease,
        box-shadow 0.13s ease, border-color 0.13s ease;
    }
    body.light button {
      background: linear-gradient(135deg, #ffffff, #edf0ff);
      box-shadow: 0 4px 14px rgba(20, 27, 70, 0.15);
    }
    button:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 26px rgba(0, 0, 0, 0.45);
    }

    .chip-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: rgba(5, 7, 15, 0.3);
      padding: 4px 9px;
      font-size: 11px;
      color: var(--fg-muted);
    }
    body.light .chip-toggle {
      background: rgba(255, 255, 255, 0.8);
    }
    .chip-toggle input {
      margin: 0;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(260px, 300px) minmax(0, 1fr);
      gap: 16px;
      align-items: stretch;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      .shell {
        padding: 12px 10px 20px;
      }

      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .topbar-actions {
        width: 100%;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 8px;
      }

      .topbar-actions button,
      .topbar-actions .chip-toggle {
        flex: 1 1 48%;
        min-width: 0;
      }

      .layout {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .panel {
        padding: 12px;
      }

      .conversation-list {
        max-height: 180px;
      }

      .pre-block {
        max-height: 220px;
      }

      .footer-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .row {
        flex-wrap: wrap;
      }

      .audio-controls {
        width: 100%;
        justify-content: flex-start;
      }
    }

    .panel {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #1c2240 0, var(--bg-elevated) 45%);
      border: 1px solid var(--border-subtle);
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }
    body.light .panel {
      background: linear-gradient(145deg, #ffffff 0, #f2f4ff 40%);
      box-shadow: 0 10px 30px rgba(31, 41, 88, 0.18);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 2px;
    }
    .panel-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--fg-muted);
    }
    .panel-sub {
      font-size: 11px;
      color: var(--fg-muted);
    }

    .conversation-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 260px;
      overflow-y: auto;
    }
    .conversation-item {
      border-radius: var(--radius-md);
      padding: 7px 9px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid transparent;
      background: rgba(10, 13, 26, 0.4);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .conversation-item:hover {
      border-color: var(--accent-soft);
      background: rgba(20, 32, 70, 0.7);
    }
    .conversation-item.active {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    .conversation-title {
      font-weight: 500;
      font-size: 12px;
    }
    .conversation-meta {
      font-size: 10px;
      color: var(--fg-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .conversation-last {
      font-size: 11px;
      color: var(--fg-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .field-stack {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    textarea, input[type="text"], input[type="password"] {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(4, 6, 18, 0.85);
      color: var(--fg);
      padding: 8px 9px;
      font-size: 13px;
      resize: vertical;
      min-height: 70px;
      outline: none;
    }
    body.light textarea,
    body.light input[type="text"],
    body.light input[type="password"] {
      background: rgba(255, 255, 255, 0.95);
    }
    textarea:focus,
    input[type="text"]:focus,
    input[type="password"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79, 140, 255, 0.3);
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .row-right {
      margin-left: auto;
    }

    .badge-soft {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 170, 110, 0.12);
      color: #8bf1c7;
      border: 1px solid rgba(44, 189, 132, 0.4);
    }

    .audio-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .mic-button {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at 20% 0, #ff9f9f, #ff4b6a 45%, #7a1434 85%);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7);
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }
    .mic-button span {
      font-size: 16px;
    }
    .mic-button.recording {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
      border-color: var(--danger);
    }

    .checkbox-inline {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--fg-muted);
    }

    .pre-block {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(4, 7, 18, 0.9);
      color: var(--fg);
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 11px;
      padding: 9px 10px;
      white-space: pre-wrap;
      max-height: 220px;
      overflow-y: auto;
    }
    body.light .pre-block {
      background: rgba(255, 255, 255, 0.95);
    }

    .footer-row {
      font-size: 10px;
      color: var(--fg-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
      opacity: 0.9;
    }
  </style>
</head>
<body class="dark">
  <div class="shell">
    <header class="topbar">
      <div class="identity">
        <div class="logo-pill">S</div>
        <div class="identity-main">
          <div class="identity-title">S.A.R.A. HUD</div>
          <div class="identity-name">api.saralabs.xyz</div>
        </div>
      </div>
      <div class="topbar-actions">
        <label class="chip-toggle">
          <input type="checkbox" id="autoSpeakToggle" checked />
          <span>Auto speak</span>
        </label>
        <button id="toggleThemeBtn">Toggle Theme</button>
        <button id="openDocsBtn">Open API docs</button>
        <button id="openFinanceBtn">Finance</button>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT: Conversations + advanced -->
      <aside class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Conversations</div>
            <div class="panel-sub">Latest chats (persisted in SQLite)</div>
          </div>
          <button id="newConversationBtn" style="padding:5px 10px;font-size:12px;">+ New</button>
        </div>

        <ul id="conversationList" class="conversation-list"></ul>

        <div class="field-stack">
          <label style="font-size:11px;color:var(--fg-muted);">
            Search (local only)
          </label>
          <input
            type="text"
            id="conversationSearch"
            placeholder="Filter by title or last message‚Ä¶"
            style="min-height:auto;"
          />
        </div>

        <div class="field-stack" style="margin-top:10px;">
          <label style="font-size:11px;color:var(--fg-muted);">
            API key (optional)
          </label>
          <input
            type="password"
            id="apiKeyInput"
            placeholder="Bearer key if ENFORCE_API_KEY=true"
            style="min-height:auto;"
          />
        </div>

        <div class="footer-row">
          <span id="hudStatus">Idle</span>
          <span id="convHint">Click a conversation or start a new one.</span>
        </div>
      </aside>

      <!-- RIGHT: Current card + reflection + voice -->
      <section class="panel">
        <!-- Current card -->
        <div class="panel-header">
          <div>
            <div class="panel-title">Current Card</div>
            <div class="panel-sub">Composed by your backend AI coach service</div>
          </div>
          <button id="refreshCardBtn" style="font-size:11px;padding:5px 10px;">
            Refresh
          </button>
        </div>
        <pre id="currentCard" class="pre-block">Loading‚Ä¶</pre>

        <!-- Reflection / chat -->
        <div class="field-stack">
          <label style="font-size:11px;color:var(--fg-muted);">
            What‚Äôs on your mind?
            <span style="opacity:0.8;">(Cmd/Ctrl + Enter to ask)</span>
          </label>
          <textarea
            id="reflectionInput"
            placeholder="Type a quick note or question to S.A.R.A.‚Ä¶"
          ></textarea>
        </div>

        <div class="row" style="margin-top:4px;">
          <button id="saveReflectionBtn">Save Reflection</button>
          <button id="askSaraBtn">Ask SARA</button>
          <span class="badge-soft">v0.2 ¬∑ text + voice</span>
          <div class="row-right audio-controls">
            <div id="micButton" class="mic-button" title="Click to start/stop recording">
              <span id="micIcon">üéô</span>
            </div>
            <label class="checkbox-inline">
              <input type="checkbox" id="autoListenToggle" />
              <span>Auto-listen (beta)</span>
            </label>
            <label class="checkbox-inline">
              <input type="checkbox" id="wakeWordToggle" />
              <span>Wake word: ‚ÄúHey SARA‚Äù</span>
            </label>
          </div>
        </div>

        <div class="field-stack" style="margin-top:10px;">
          <label style="font-size:11px;color:var(--fg-muted);">Last result</label>
          <pre id="lastResult" class="pre-block">_</pre>
        </div>

        <div class="footer-row">
          <span id="voiceStatus">Voice: idle</span>
          <span id="summaryHint">
            Tip: hit /api/dailySummary later for a day recap.
          </span>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- Helpers ---
    const apiBase = ""; // same origin (api.saralabs.xyz or onrender)
    const $ = (id) => document.getElementById(id);

    function buildHeaders(json = true) {
      const headers = {};
      if (json) headers["Content-Type"] = "application/json";
      const key = $("apiKeyInput").value.trim();
      if (key) headers["Authorization"] = "Bearer " + key;
      return headers;
    }

    function setHudStatus(text) {
      $("hudStatus").textContent = text;
    }
    function setVoiceStatus(text) {
      $("voiceStatus").textContent = "Voice: " + text;
    }
    function setLastResult(text) {
      $("lastResult").textContent = text || "_";
    }

    let currentConversationId = null;
    let conversationsCache = [];

    async function loadCurrentCard() {
      try {
        const res = await fetch(apiBase + "/api/currentCard");
        const data = await res.json();
        $("currentCard").textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        $("currentCard").textContent = "Error loading current card: " + e;
      }
    }

    async function saveReflection() {
      const text = ($("reflectionInput").value || "").trim();
      if (!text) return;
      try {
        setHudStatus("Saving reflection‚Ä¶");
        const res = await fetch(apiBase + "/api/reflect", {
          method: "POST",
          headers: buildHeaders(true),
          body: JSON.stringify({ text }),
        });
        const data = await res.json();
        setHudStatus("Reflection saved.");
        setLastResult(data.summary || JSON.stringify(data, null, 2));
      } catch (e) {
        setHudStatus("Reflection error");
        setLastResult("Error: " + e);
      }
    }

    // --- Conversations ---
    async function refreshConversations() {
      try {
        const res = await fetch(apiBase + "/api/conversations?limit=30", {
          headers: buildHeaders(false),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        conversationsCache = data.items || [];
        renderConversationList();
      } catch (e) {
        console.error(e);
        setHudStatus("Conversations error");
      }
    }

    function renderConversationList() {
      const ul = $("conversationList");
      ul.innerHTML = "";
      const q = $("conversationSearch").value.toLowerCase().trim();
      const items = conversationsCache.filter((c) => {
        if (!q) return true;
        const haystack =
          (c.title || "") +
          " " +
          ((c.last_text || "") + "").toLowerCase();
        return haystack.toLowerCase().includes(q);
      });

      if (items.length === 0) {
        const li = document.createElement("li");
        li.style.fontSize = "11px";
        li.style.color = "var(--fg-muted)";
        li.textContent = q
          ? "No conversations match your filter."
          : "No conversations yet. Start one with Ask SARA.";
        ul.appendChild(li);
        return;
      }

      for (const c of items) {
        const li = document.createElement("li");
        li.className =
          "conversation-item" +
          (currentConversationId === c.id ? " active" : "");
        li.dataset.id = c.id;

        const title = document.createElement("div");
        title.className = "conversation-title";
        title.textContent = c.title || "(untitled)";
        li.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "conversation-meta";
        meta.innerHTML =
          `<span>#${c.id}</span><span>${(c.created_at || "").slice(0, 16)}</span>`;
        li.appendChild(meta);

        const last = document.createElement("div");
        last.className = "conversation-last";
        last.textContent = c.last_text || "";
        li.appendChild(last);

        li.onclick = () => {
          currentConversationId = c.id;
          $("convHint").textContent = `Active conversation #${c.id}`;
          renderConversationList();
        };

        ul.appendChild(li);
      }
    }

    async function newConversation() {
      try {
        setHudStatus("Creating conversation‚Ä¶");
        const res = await fetch(apiBase + "/api/conversations", {
          method: "POST",
          headers: buildHeaders(true),
          body: JSON.stringify({ title: "Untitled" }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        currentConversationId = data.id;
        $("convHint").textContent = `Active conversation #${data.id}`;
        await refreshConversations();
        setHudStatus("Conversation created");
      } catch (e) {
        setHudStatus("New conversation error");
        console.error(e);
      }
    }

    // --- Chat & Voice ---
    async function sendTextToSara(text, opts = {}) {
      const autoSpeakPreferred = !!opts.speakPreferred;
      const autoSpeak = $("autoSpeakToggle").checked && autoSpeakPreferred;

      if (!text || !text.trim()) return;
      const payload = {
        text: text.trim(),
        conversation_id: currentConversationId,
      };

      try {
        setHudStatus(autoSpeak ? "Speaking‚Ä¶" : "Thinking‚Ä¶");
        if (autoSpeak) {
          const res = await fetch(apiBase + "/api/speak", {
            method: "POST",
            headers: buildHeaders(true),
            body: JSON.stringify(payload),
          });
          if (!res.ok)
            throw new Error("speak failed: " + (await res.text()));

          const cid = res.headers.get("X-Conversation-Id");
          if (cid) currentConversationId = parseInt(cid, 10);

          const replyB64 = res.headers.get("X-Reply-Text-B64");
          let replyText = "";
          if (replyB64) {
            try {
              replyText = atob(replyB64);
            } catch {}
          }
          setLastResult(replyText || "[Voice reply sent]");
          $("convHint").textContent = `Active conversation #${currentConversationId}`;

          const buf = await res.arrayBuffer();
          const blob = new Blob([buf], { type: "audio/mpeg" });
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          audio.play();

          await refreshConversations();
        } else {
          const res = await fetch(apiBase + "/api/chat", {
            method: "POST",
            headers: buildHeaders(true),
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || "chat failed");
          currentConversationId = data.conversation_id;
          setLastResult(data.reply || "");
          $("convHint").textContent = `Active conversation #${currentConversationId}`;
          await refreshConversations();
        }
        setHudStatus("Ready");
      } catch (e) {
        console.error(e);
        setHudStatus("Chat error");
        setLastResult("Error: " + e);
      }
    }

    // --- Mic / STT / Auto-listen / Wake word ---
    let mediaStream = null;
    let mediaRecorder = null;
    let chunks = [];
    let isRecording = false;
    let autoListenEnabled = false;
    let wakeWordEnabled = false;

    async function ensureMediaStream() {
      if (!mediaStream) {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
      }
    }

    function updateMicUI() {
      const btn = $("micButton");
      $("micIcon").textContent = isRecording ? "‚èπ" : "üéô";
      if (isRecording) {
        btn.classList.add("recording");
        setVoiceStatus("recording‚Ä¶");
      } else {
        btn.classList.remove("recording");
        if (!autoListenEnabled) setVoiceStatus("idle");
      }
    }

    async function startMicOnce() {
      try {
        await ensureMediaStream();
        chunks = [];
        mediaRecorder = new MediaRecorder(mediaStream);
        isRecording = true;
        updateMicUI();

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };
        mediaRecorder.onstop = () => {
          isRecording = false;
          updateMicUI();
          const blob = new Blob(chunks, { type: "audio/webm" });
          handleRecordedBlob(blob).catch(console.error);
        };

        mediaRecorder.start();
        // safety stop at ~8s
        setTimeout(() => {
          if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
          }
        }, 8000);
      } catch (e) {
        console.error(e);
        setVoiceStatus("mic error");
      }
    }

    function stopMic() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    }

    function scheduleNextListen() {
      if (!autoListenEnabled) return;
      setTimeout(() => {
        if (autoListenEnabled && !isRecording) {
          startMicOnce().catch(console.error);
        }
      }, 600);
    }

    async function handleRecordedBlob(blob) {
      try {
        setVoiceStatus("transcribing‚Ä¶");
        const form = new FormData();
        form.append("audio", blob, "mic.webm");

        const headers = buildHeaders(false);
        const res = await fetch(apiBase + "/api/stt", {
          method: "POST",
          headers,
          body: form,
        });
        const data = await res.json();
        if (!data.ok) {
          setLastResult("STT error: " + (data.error || "failed"));
          setVoiceStatus("idle");
          scheduleNextListen();
          return;
        }

        let text = (data.text || "").trim();
        if (!text) {
          setVoiceStatus("idle (no speech)");
          scheduleNextListen();
          return;
        }

        if (wakeWordEnabled) {
          const lower = text.toLowerCase();
          const phrase = "hey sara";
          const idx = lower.indexOf(phrase);
          if (idx === -1) {
            setLastResult("Wake word not detected. Heard: " + text);
            setVoiceStatus("listening for wake word");
            scheduleNextListen();
            return;
          }
          text = text.slice(idx + phrase.length).trim() || "Hello.";
        }

        setLastResult("You: " + text);
        await sendTextToSara(text, { speakPreferred: true });
        setVoiceStatus("idle");
        scheduleNextListen();
      } catch (e) {
        console.error(e);
        setLastResult("Voice error: " + e);
        setVoiceStatus("idle");
        scheduleNextListen();
      }
    }

    // --- Wiring ---
    $("toggleThemeBtn").onclick = () => {
      document.body.classList.toggle("light");
    };
    $("openDocsBtn").onclick = () => {
      window.open("/docs", "_blank");
    };
    $("openFinanceBtn").onclick = () => {
      window.open("/hud/finance.html", "_blank");
    };
    $("refreshCardBtn").onclick = loadCurrentCard;
    $("saveReflectionBtn").onclick = saveReflection;
    $("askSaraBtn").onclick = () => {
      const text = $("reflectionInput").value;
      sendTextToSara(text, { speakPreferred: true });
    };
    $("reflectionInput").addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
        e.preventDefault();
        const text = $("reflectionInput").value;
        sendTextToSara(text, { speakPreferred: true });
      }
    });

    $("newConversationBtn").onclick = newConversation;
    $("conversationSearch").addEventListener("input", renderConversationList);

    $("micButton").onclick = () => {
      if (isRecording) {
        stopMic();
      } else {
        autoListenEnabled = false;
        $("autoListenToggle").checked = false;
        startMicOnce().catch(console.error);
      }
    };

    $("autoListenToggle").onchange = (e) => {
      autoListenEnabled = e.target.checked;
      if (autoListenEnabled && !isRecording) {
        setVoiceStatus(
          wakeWordEnabled ? "auto-listen (wake word)" : "auto-listen"
        );
        startMicOnce().catch(console.error);
      } else if (!autoListenEnabled && !isRecording) {
        setVoiceStatus("idle");
      }
    };

    $("wakeWordToggle").onchange = (e) => {
      wakeWordEnabled = e.target.checked;
      if (wakeWordEnabled && autoListenEnabled) {
        setVoiceStatus("auto-listen (wake word)");
      }
    };

    // Initial load
    (async function init() {
      setHudStatus("Booting‚Ä¶");
      await loadCurrentCard();
      await refreshConversations();
      setHudStatus("Ready");
      setLastResult("_");
    })();
  </script>
</body>
</html>