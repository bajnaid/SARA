<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SARA HUD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #05060a;
      --bg-alt: #0c0f18;
      --bg-elevated: #101320;
      --fg: #f5f7ff;
      --fg-muted: #9aa2c0;
      --accent: #4f8cff;
      --accent-soft: rgba(79, 140, 255, 0.14);
      --border-subtle: #202436;
      --danger: #ff4760;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-pill: 999px;
      --shadow-soft: 0 20px 45px rgba(0, 0, 0, 0.45);
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Helvetica Neue", sans-serif;
    }

    /* Aquire wordmark */
    @font-face {
      font-family: "Aquire";
      src: url("/hud/assets/fonts/Aquire-BW0ox.otf") format("opentype");
      font-display: swap;
    }

    .wordmark {
      font-family: "Aquire", var(--font-sans);
      letter-spacing: 0.08em;
      font-size: 22px;
      line-height: 1;
      text-transform: uppercase;
    }

    /* pill actions */
    .pills {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill-action {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: rgba(10, 13, 26, 0.35);
      padding: 7px 12px;
      font-size: 12px;
      color: var(--fg);
      cursor: pointer;
      transition: transform 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      display: inline-flex;
      align-items: center;
      gap: 7px;
      user-select: none;
    }

    body.light .pill-action {
      background: rgba(255,255,255,0.75);
      box-shadow: 0 10px 25px rgba(31, 41, 88, 0.12);
    }

    .pill-action:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
      box-shadow: 0 16px 40px rgba(0,0,0,0.45);
    }

    /* mini cards */
    .mini-card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      background: rgba(6, 8, 18, 0.45);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    body.light .mini-card { background: rgba(255,255,255,0.85); }

    .mini-row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .muted { color: var(--fg-muted); font-size: 12px; }

    .input-inline {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(4, 6, 18, 0.85);
      color: var(--fg);
      padding: 8px 9px;
      font-size: 13px;
      outline: none;
      min-height: auto;
    }
    body.light .input-inline { background: rgba(255, 255, 255, 0.95); }

    /* onboarding modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 9999;
    }
    .modal-overlay.show { display: flex; }

    .modal {
      width: 100%;
      max-width: 720px;
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at top left, #1c2240 0, var(--bg-elevated) 55%);
      box-shadow: 0 35px 90px rgba(0,0,0,0.6);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    body.light .modal {
      background: linear-gradient(145deg, #ffffff 0, #f2f4ff 50%);
      box-shadow: 0 35px 90px rgba(31,41,88,0.22);
    }
    .modal h2 { margin: 0; font-size: 16px; letter-spacing: 0.04em; text-transform: uppercase; }
    .modal p { margin: 0; color: var(--fg-muted); font-size: 13px; line-height: 1.5; }
    .modal ul { margin: 0; padding-left: 18px; color: var(--fg); font-size: 13px; line-height: 1.55; }
    .modal .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #15192a 0, #05060a 45%, #000 100%);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }
    body.light {
      --bg: #f5f7ff;
      --bg-alt: #eef1ff;
      --bg-elevated: #ffffff;
      --fg: #070816;
      --fg-muted: #6c708b;
      --accent-soft: rgba(79, 140, 255, 0.12);
      --border-subtle: #d2d6f0;
      background: radial-gradient(circle at top, #ffffff 0, #eef1ff 40%, #e2e6ff 100%);
    }

    .shell {
      width: 100%;
      max-width: 1200px;
      padding: 20px 24px 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .identity {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-pill {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: radial-gradient(circle at 20% 0, #7be3ff, #4f8cff 40%, #914bff 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }
    .identity-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .identity-title {
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-size: 11px;
      color: var(--fg-muted);
    }
    .identity-name {
      font-size: 14px;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    button, .btn {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: linear-gradient(135deg, #141827, #0b0e19);
      color: var(--fg);
      font-size: 13px;
      padding: 7px 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      outline: none;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.35);
      transition: background 0.13s ease, transform 0.12s ease,
        box-shadow 0.13s ease, border-color 0.13s ease;
    }
    body.light button {
      background: linear-gradient(135deg, #ffffff, #edf0ff);
      box-shadow: 0 4px 14px rgba(20, 27, 70, 0.15);
    }
    button:hover {
      transform: translateY(-1px);
      border-color: var(--accent);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 6px 26px rgba(0, 0, 0, 0.45);
    }

    .chip-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-subtle);
      background: rgba(5, 7, 15, 0.3);
      padding: 4px 9px;
      font-size: 11px;
      color: var(--fg-muted);
    }
    body.light .chip-toggle {
      background: rgba(255, 255, 255, 0.8);
    }
    .chip-toggle input {
      margin: 0;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(260px, 300px) minmax(0, 1fr);
      gap: 16px;
      align-items: stretch;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      .shell {
        padding: 12px 10px 20px;
      }

      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .topbar-actions {
        width: 100%;
        flex-wrap: wrap;
        justify-content: flex-start;
        gap: 8px;
      }

      .topbar-actions button,
      .topbar-actions .chip-toggle {
        flex: 1 1 48%;
        min-width: 0;
      }

      .layout {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .layout > section {
        order: 1;
      }

      .layout > aside {
        order: 2;
      }

      .panel {
        padding: 12px;
      }

      .conversation-list {
        max-height: 180px;
      }

      .pre-block {
        max-height: 220px;
      }

      .footer-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .row {
        flex-wrap: wrap;
      }

      .audio-controls {
        width: 100%;
        justify-content: flex-start;
      }
    }

    .panel {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #1c2240 0, var(--bg-elevated) 45%);
      border: 1px solid var(--border-subtle);
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }
    body.light .panel {
      background: linear-gradient(145deg, #ffffff 0, #f2f4ff 40%);
      box-shadow: 0 10px 30px rgba(31, 41, 88, 0.18);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 2px;
    }
    .panel-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--fg-muted);
    }
    .panel-sub {
      font-size: 11px;
      color: var(--fg-muted);
    }

    .conversation-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 260px;
      overflow-y: auto;
    }
    .conversation-item {
      border-radius: var(--radius-md);
      padding: 7px 9px;
      font-size: 12px;
      cursor: pointer;
      border: 1px solid transparent;
      background: rgba(10, 13, 26, 0.4);
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .conversation-item:hover {
      border-color: var(--accent-soft);
      background: rgba(20, 32, 70, 0.7);
    }
    .conversation-item.active {
      border-color: var(--accent);
      background: var(--accent-soft);
    }
    .conversation-title {
      font-weight: 500;
      font-size: 12px;
    }
    .conversation-meta {
      font-size: 10px;
      color: var(--fg-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .conversation-last {
      font-size: 11px;
      color: var(--fg-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .field-stack {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    textarea, input[type="text"], input[type="password"] {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(4, 6, 18, 0.85);
      color: var(--fg);
      padding: 8px 9px;
      font-size: 13px;
      resize: vertical;
      min-height: 70px;
      outline: none;
    }
    body.light textarea,
    body.light input[type="text"],
    body.light input[type="password"] {
      background: rgba(255, 255, 255, 0.95);
    }
    textarea:focus,
    input[type="text"]:focus,
    input[type="password"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79, 140, 255, 0.3);
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .row-right {
      margin-left: auto;
    }

    .badge-soft {
      font-size: 10px;
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 170, 110, 0.12);
      color: #8bf1c7;
      border: 1px solid rgba(44, 189, 132, 0.4);
    }

    .audio-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .mic-button {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: radial-gradient(circle at 20% 0, #ff9f9f, #ff4b6a 45%, #7a1434 85%);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7);
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }
    .mic-button span {
      font-size: 16px;
    }
    .mic-button.recording {
      transform: translateY(1px) scale(0.97);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
      border-color: var(--danger);
    }

    .checkbox-inline {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--fg-muted);
    }

    .pre-block {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(4, 7, 18, 0.9);
      color: var(--fg);
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 11px;
      padding: 9px 10px;
      white-space: pre-wrap;
      max-height: 220px;
      overflow-y: auto;
    }
    .tasks-card {
      font-family: var(--font-sans);
      font-size: 12px;
      line-height: 1.45;
      white-space: normal;
    }

    .tasks-card ul {
      margin: 0;
      padding-left: 18px;
    }

    .tasks-card li {
      margin-bottom: 4px;
    }
    body.light .pre-block {
      background: rgba(255, 255, 255, 0.95);
    }

    .footer-row {
      font-size: 10px;
      color: var(--fg-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 4px;
      opacity: 0.9;
    }
  </style>
</head>
<body class="dark">
  <div id="onboardingOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="onboardingTitle">
      <h2 id="onboardingTitle">Welcome to S.A.R.A. (MVP)</h2>
      <p>
        This is an early build for creatives who want daily clarity without spreadsheets.
        Use it for quick reflections, lightweight planning, and spending awareness.
      </p>
      <ul>
        <li><strong>Login</strong> with email + password to unlock your personal data.</li>
        <li><strong>Ask S.A.R.A.</strong> a question or drop a reflection. Cmd/Ctrl + Enter sends.</li>
        <li><strong>Finance</strong>: log spending in Finance (example: ‚Äú$7 lunch, calm‚Äù).</li>
        <li><strong>Privacy</strong>: you control what you enter. No bank sync in this MVP.</li>
      </ul>
      <p class="muted">Expect rough edges. If anything is confusing, tell Saif what broke or what you expected.</p>
      <div class="modal-actions">
        <button id="onboardingCloseBtn">OK, got it</button>
      </div>
    </div>
  </div>
  <div class="shell">
    <header class="topbar">
      <div class="identity">
        <div class="identity-main">
          <div class="wordmark">S.A.R.A</div>
          <div class="identity-title">api.saralabs.xyz</div>
        </div>
      </div>

      <div class="topbar-actions">
        <div class="pills">
          <button class="pill-action" id="howToBtn">How to use</button>
          <button class="pill-action" id="openDocsBtn">API docs</button>
          <button class="pill-action" id="openFinanceBtn">Finance</button>

          <label class="chip-toggle">
            <input type="checkbox" id="autoSpeakToggle" checked />
            <span>Auto speak</span>
          </label>

          <button id="toggleThemeBtn">Toggle Theme</button>
        </div>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT: Conversations + advanced -->
      <aside class="panel">
        <div class="panel-header">
          <div>
            <div class="panel-title">Conversations</div>
            <div class="panel-sub">Latest chats (persisted in SQLite)</div>
          </div>
          <button id="newConversationBtn" style="padding:5px 10px;font-size:12px;">+ New</button>
        </div>

        <ul id="conversationList" class="conversation-list"></ul>

        <div class="field-stack">
          <label style="font-size:11px;color:var(--fg-muted);">
            Search (local only)
          </label>
          <input
            type="text"
            id="conversationSearch"
            placeholder="Filter by title or last message‚Ä¶"
            style="min-height:auto;"
          />
        </div>

        <div class="field-stack" style="margin-top:10px;">
          <label style="font-size:11px;color:var(--fg-muted);">
            API key (optional)
          </label>
          <input
            type="password"
            id="apiKeyInput"
            placeholder="Bearer key if ENFORCE_API_KEY=true"
            style="min-height:auto;"
          />
        </div>

        <div class="field-stack" style="margin-top:10px;">
          <label style="font-size:11px;color:var(--fg-muted);">
            Login (email + password)
          </label>
          <input
            type="text"
            id="emailInput"
            placeholder="Email (e.g. saif@example.com)"
            style="min-height:auto;margin-bottom:6px;"
          />
          <input
            type="password"
            id="passwordInput"
            placeholder="Password"
            style="min-height:auto;margin-bottom:8px;"
          />
          <div class="row">
            <button id="loginBtn" style="font-size:11px;padding:5px 10px;">
              Login
            </button>
            <button id="logoutBtn" style="font-size:11px;padding:5px 10px;">
              Logout
            </button>
          </div>
        </div>

        <div class="footer-row">
          <span id="hudStatus">Idle</span>
          <span id="userStatus">Auth: not logged in</span>
          <span id="convHint">Click a conversation or start a new one.</span>
        </div>
      </aside>

      <!-- RIGHT: Reflection + current tasks + voice -->
      <section class="panel">
        <!-- Reflection / chat -->
        <div class="field-stack">
          <label style="font-size:11px;color:var(--fg-muted);">
            What‚Äôs on your mind?
            <span style="opacity:0.8;">(Cmd/Ctrl + Enter to ask)</span>
          </label>
          <textarea
            id="reflectionInput"
            placeholder="Type a quick note or question to S.A.R.A.‚Ä¶"
          ></textarea>
        </div>

        <div class="row" style="margin-top:4px;">
          <button id="saveReflectionBtn">Save Reflection</button>
          <button id="askSaraBtn">Ask SARA</button>
          <span class="badge-soft">v0.2 ¬∑ text + voice</span>
          <div class="row-right audio-controls">
            <div id="micButton" class="mic-button" title="Click to start/stop recording">
              <span id="micIcon">üéô</span>
            </div>
            <label class="checkbox-inline">
              <input type="checkbox" id="autoListenToggle" />
              <span>Auto-listen (beta)</span>
            </label>
            <label class="checkbox-inline">
              <input type="checkbox" id="wakeWordToggle" />
              <span>Wake word: ‚ÄúHey SARA‚Äù</span>
            </label>
          </div>
        </div>

        <div class="field-stack" style="margin-top:10px;">
          <label style="font-size:11px;color:var(--fg-muted);">Last result</label>
          <pre id="lastResult" class="pre-block">_</pre>
        </div>

        <!-- Current tasks card -->
        <div class="panel-header" style="margin-top:10px;">
          <div>
            <div class="panel-title">Current Tasks</div>
            <div class="panel-sub">Small list of things worth doing today</div>
          </div>
          <button id="refreshCardBtn" style="font-size:11px;padding:5px 10px;">
            Refresh
          </button>
        </div>
        <div id="currentTasksCard" class="pre-block tasks-card">Loading‚Ä¶</div>

        <div class="mini-card" style="margin-top:10px;">
          <div class="mini-row">
            <div>
              <div class="panel-title" style="margin:0;">Your tasks</div>
              <div class="panel-sub">Local list (add/remove). Doesn‚Äôt affect backend yet.</div>
            </div>
            <button id="clearLocalTasksBtn" style="font-size:11px;padding:5px 10px;">Clear</button>
          </div>

          <div class="row" style="width:100%;">
            <input id="taskInput" class="input-inline" type="text" placeholder="Add a task (e.g., ‚ÄòFinish deck slide 6‚Äô)" />
            <button id="addTaskBtn" style="white-space:nowrap;">Add</button>
          </div>

          <div id="localTasksList" class="pre-block tasks-card" style="margin:0;">Loading‚Ä¶</div>
        </div>

        <div class="mini-card" style="margin-top:10px;">
          <div class="mini-row">
            <div>
              <div class="panel-title" style="margin:0;">Budget outlook</div>
              <div class="panel-sub">Today‚Äôs spend (from your Finance logs)</div>
            </div>
            <button id="refreshBudgetBtn" style="font-size:11px;padding:5px 10px;">Refresh</button>
          </div>
          <div class="mini-row">
            <div>
              <div style="font-size:26px;font-weight:700;" id="budgetTodayValue">‚Äî</div>
              <div class="muted" id="budgetTodayMeta">Log an expense to see this update.</div>
            </div>
            <button id="goFinanceBtn">Open Finance</button>
          </div>
        </div>

        <div class="footer-row">
          <span id="voiceStatus">Voice: idle</span>
          <span id="summaryHint">
            Tip: hit /api/dailySummary later for a day recap.
          </span>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- Helpers ---
    const apiBase = ""; // same origin (api.saralabs.xyz or onrender)
    const $ = (id) => document.getElementById(id);

    let authToken = null;

    function getStoredToken() {
      try {
        return localStorage.getItem("sara_token") || null;
      } catch {
        return null;
      }
    }

    function updateUserStatus() {
      const el = $("userStatus");
      if (!el) return;
      if (authToken) {
        el.textContent = "Auth: logged in";
      } else if (($("apiKeyInput")?.value || "").trim()) {
        el.textContent = "Auth: API key";
      } else {
        el.textContent = "Auth: not logged in";
      }
    }

    function setAuthToken(token) {
      authToken = token || null;
      try {
        if (authToken) {
          localStorage.setItem("sara_token", authToken);
        } else {
          localStorage.removeItem("sara_token");
        }
      } catch {}
      updateUserStatus();
    }

    function buildHeaders(json = true) {
      const headers = {};
      if (json) headers["Content-Type"] = "application/json";

      // JWT ‚Üí Authorization
      const token = authToken || getStoredToken();
      if (token) {
        headers["Authorization"] = "Bearer " + token;
        return headers;
      }

      // API key ‚Üí X-API-Key (never Authorization)
      const key = ($("apiKeyInput")?.value || "").trim();
      if (key) {
        headers["X-API-Key"] = key;
      }

      return headers;
    }

    async function authFetch(path, options = {}) {
      const opts = { ...options };
      const isFormData = opts.body instanceof FormData;

      // For JSON bodies or GETs, let buildHeaders set Content-Type; for FormData, skip json flag
      const baseHeaders = buildHeaders(!isFormData);
      opts.headers = { ...baseHeaders, ...(opts.headers || {}) };

      const res = await fetch(apiBase + path, opts);

      // If JWT expired/invalid, clear token so UI reflects reality
      if (res.status === 401) {
        setAuthToken(null);
        setHudStatus("Auth expired. Please login again.");
      }

      return res;
    }

    function setHudStatus(text) {
      $("hudStatus").textContent = text;
    }
    function setVoiceStatus(text) {
      $("voiceStatus").textContent = "Voice: " + text;
    }
    function setLastResult(text) {
      $("lastResult").textContent = text || "_";
    }

    let currentConversationId = null;
    let conversationsCache = [];


    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // --- Onboarding + local tasks + budget mini ---
    const ONBOARD_KEY = "sara_onboarded_v1";
    const LOCAL_TASKS_KEY = "sara_local_tasks_v1";

    function showOnboarding() {
      const overlay = $("onboardingOverlay");
      if (!overlay) return;
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden", "false");
    }
    function hideOnboarding() {
      const overlay = $("onboardingOverlay");
      if (!overlay) return;
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden", "true");
    }
    function hasOnboarded() {
      try { return localStorage.getItem(ONBOARD_KEY) === "1"; } catch { return false; }
    }
    function setOnboarded() {
      try { localStorage.setItem(ONBOARD_KEY, "1"); } catch {}
    }

    function readLocalTasks() {
      try {
        const raw = localStorage.getItem(LOCAL_TASKS_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }
    function writeLocalTasks(tasks) {
      try { localStorage.setItem(LOCAL_TASKS_KEY, JSON.stringify(tasks || [])); } catch {}
    }

    function renderLocalTasks() {
      const el = $("localTasksList");
      if (!el) return;
      const tasks = readLocalTasks();
      if (!tasks.length) {
        el.innerHTML = "<em>No tasks yet. Add one above.</em>";
        return;
      }
      const items = tasks.map((t, idx) => {
        const safe = escapeHtml(t);
        return `<li style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <span>${safe}</span>
          <button data-idx="${idx}" class="pill-action" style="padding:4px 10px;font-size:11px;">Remove</button>
        </li>`;
      }).join("");
      el.innerHTML = `<ul style="margin:0;padding-left:18px;display:flex;flex-direction:column;gap:6px;">${items}</ul>`;

      el.querySelectorAll("button[data-idx]").forEach((btn) => {
        btn.onclick = () => {
          const i = parseInt(btn.getAttribute("data-idx"), 10);
          const next = readLocalTasks().filter((_, j) => j !== i);
          writeLocalTasks(next);
          renderLocalTasks();
        };
      });
    }

    function addLocalTaskFromInput() {
      const input = $("taskInput");
      if (!input) return;
      const text = (input.value || "").trim();
      if (!text) return;
      const tasks = readLocalTasks();
      tasks.unshift(text);
      writeLocalTasks(tasks.slice(0, 25));
      input.value = "";
      renderLocalTasks();
    }
    function clearLocalTasks() {
      writeLocalTasks([]);
      renderLocalTasks();
    }

    async function loadBudgetMini() {
      const val = $("budgetTodayValue");
      const meta = $("budgetTodayMeta");
      if (!val || !meta) return;

      try {
        val.textContent = "‚Ä¶";
        meta.textContent = "Fetching today‚Äôs logs‚Ä¶";

        const res = await authFetch("/api/finance/today");
        if (!res.ok) throw new Error(await res.text());

        const items = await res.json();
        const rows = Array.isArray(items) ? items : [];
        const total = rows.reduce((acc, r) => acc + (Number(r.amount) || 0), 0);
        const currency = (rows[0] && rows[0].currency) ? rows[0].currency : "USD";
        val.textContent = `${total.toFixed(2)} ${currency}`;
        meta.textContent = rows.length ? `${rows.length} transaction(s) today.` : "No transactions today yet.";
      } catch (e) {
        val.textContent = "‚Äî";
        meta.textContent = "Budget preview unavailable (are you logged in?).";
        console.error(e);
      }
    }

    function renderCurrentTasks(data) {
      if (!data) {
        return "<em>No tasks yet. Save a reflection and I‚Äôll suggest one.</em>";
      }

      // If backend returns an array of tasks
      if (Array.isArray(data)) {
        if (data.length === 0) {
          return "<em>No tasks yet.</em>";
        }
        const items = data
          .map((t) => {
            if (typeof t === "string") return `<li>${escapeHtml(t)}</li>`;
            if (t && typeof t === "object") {
              const label = t.title || t.label || t.task || t.text || JSON.stringify(t);
              return `<li>${escapeHtml(label)}</li>`;
            }
            return "";
          })
          .join("");
        return `<ul>${items}</ul>`;
      }

      // If backend returns an object with a tasks/items array
      const tasks = Array.isArray(data.tasks)
        ? data.tasks
        : Array.isArray(data.items)
        ? data.items
        : null;
      if (tasks) {
        if (tasks.length === 0) {
          return "<em>No tasks yet.</em>";
        }
        const items = tasks
          .map((t) => {
            if (typeof t === "string") return `<li>${escapeHtml(t)}</li>`;
            if (t && typeof t === "object") {
              const label = t.title || t.label || t.task || t.text || JSON.stringify(t);
              return `<li>${escapeHtml(label)}</li>`;
            }
            return "";
          })
          .join("");
        return `<ul>${items}</ul>`;
      }

      // Fallback to title/body/cta style card
      const parts = [];
      if (data.title) {
        parts.push(
          `<div style="font-weight:600;margin-bottom:4px;">${escapeHtml(
            data.title
          )}</div>`
        );
      }
      if (data.body) {
        parts.push(
          `<div style="font-size:12px;line-height:1.4;margin-bottom:6px;">${escapeHtml(
            data.body
          )}</div>`
        );
      }
      if (data.cta) {
        parts.push(
          `<div style="font-size:11px;opacity:0.8;">${escapeHtml(data.cta)}</div>`
        );
      }
      if (parts.length > 0) {
        return parts.join("");
      }

      // Last resort: pretty-printed JSON
      return `<pre style="margin:0;white-space:pre-wrap;">${escapeHtml(
        JSON.stringify(data, null, 2)
      )}</pre>`;
    }

    async function loadCurrentCard() {
      const cardEl = $("currentTasksCard");
      if (!cardEl) return;
      try {
        const res = await authFetch("/api/currentCard");
        const data = await res.json();
        cardEl.innerHTML = renderCurrentTasks(data);
      } catch (e) {
        cardEl.textContent = "Error loading current tasks: " + e;
      }
    }

    async function saveReflection() {
      const text = ($("reflectionInput").value || "").trim();
      if (!text) return;
      try {
        setHudStatus("Saving reflection‚Ä¶");
        const res = await authFetch("/api/reflect", {
          method: "POST",
          body: JSON.stringify({ text }),
        });
        const data = await res.json();
        setHudStatus("Reflection saved.");
        setLastResult(data.summary || JSON.stringify(data, null, 2));
      } catch (e) {
        setHudStatus("Reflection error");
        setLastResult("Error: " + e);
      }
    }

    async function login() {
      const email = ($("emailInput").value || "").trim();
      const password = $("passwordInput").value || "";
      if (!email || !password) {
        setHudStatus("Email and password required.");
        return;
      }
      try {
        setHudStatus("Logging in‚Ä¶");

        // Send JSON body with email + password, matching FastAPI /api/auth/login expectations
        const res = await fetch(apiBase + "/api/auth/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ email, password }),
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || "login failed");
        }

        const data = await res.json();
        if (!data.access_token) {
          throw new Error("No access_token in response");
        }

        setAuthToken(data.access_token);
        setHudStatus("Logged in.");
        setLastResult("Logged in as " + email);
      } catch (e) {
        console.error(e);
        setHudStatus("Login error");
        setLastResult("Login error: " + e);
      }
    }

    function logout() {
      setAuthToken(null);
      if ($("emailInput")) $("emailInput").value = "";
      if ($("passwordInput")) $("passwordInput").value = "";
      setHudStatus("Logged out.");
      setLastResult("You are logged out.");
    }

    // --- Conversations ---
    async function refreshConversations() {
      try {
        const res = await authFetch("/api/conversations?limit=30");
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        conversationsCache = data.items || [];
        renderConversationList();
      } catch (e) {
        console.error(e);
        setHudStatus("Conversations error");
      }
    }

    function renderConversationList() {
      const ul = $("conversationList");
      ul.innerHTML = "";
      const q = $("conversationSearch").value.toLowerCase().trim();
      const items = conversationsCache.filter((c) => {
        if (!q) return true;
        const haystack =
          (c.title || "") +
          " " +
          ((c.last_text || "") + "").toLowerCase();
        return haystack.toLowerCase().includes(q);
      });

      if (items.length === 0) {
        const li = document.createElement("li");
        li.style.fontSize = "11px";
        li.style.color = "var(--fg-muted)";
        li.textContent = q
          ? "No conversations match your filter."
          : "No conversations yet. Start one with Ask SARA.";
        ul.appendChild(li);
        return;
      }

      for (const c of items) {
        const li = document.createElement("li");
        li.className =
          "conversation-item" +
          (currentConversationId === c.id ? " active" : "");
        li.dataset.id = c.id;

        const title = document.createElement("div");
        title.className = "conversation-title";
        title.textContent = c.title || "(untitled)";
        li.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "conversation-meta";
        meta.innerHTML =
          `<span>#${c.id}</span><span>${(c.created_at || "").slice(0, 16)}</span>`;
        li.appendChild(meta);

        const last = document.createElement("div");
        last.className = "conversation-last";
        last.textContent = c.last_text || "";
        li.appendChild(last);

        li.onclick = () => {
          currentConversationId = c.id;
          $("convHint").textContent = `Active conversation #${c.id}`;
          renderConversationList();
        };

        ul.appendChild(li);
      }
    }

    async function newConversation() {
      try {
        setHudStatus("Creating conversation‚Ä¶");
        const res = await authFetch("/api/conversations", {
          method: "POST",
          body: JSON.stringify({ title: "Untitled" }),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || "failed");
        currentConversationId = data.id;
        $("convHint").textContent = `Active conversation #${data.id}`;
        await refreshConversations();
        setHudStatus("Conversation created");
      } catch (e) {
        setHudStatus("New conversation error");
        console.error(e);
      }
    }

    // --- Chat & Voice ---
    async function sendTextToSara(text, opts = {}) {
      const autoSpeakPreferred = !!opts.speakPreferred;
      const autoSpeak = $("autoSpeakToggle").checked && autoSpeakPreferred;

      if (!text || !text.trim()) return;
      const payload = {
        text: text.trim(),
        conversation_id: currentConversationId,
      };

      try {
        setHudStatus(autoSpeak ? "Speaking‚Ä¶" : "Thinking‚Ä¶");
        if (autoSpeak) {
          const res = await authFetch("/api/speak", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          if (!res.ok)
            throw new Error("speak failed: " + (await res.text()));

          const cid = res.headers.get("X-Conversation-Id");
          if (cid) currentConversationId = parseInt(cid, 10);

          const replyB64 = res.headers.get("X-Reply-Text-B64");
          let replyText = "";
          if (replyB64) {
            try {
              replyText = atob(replyB64);
            } catch {}
          }
          setLastResult(replyText || "[Voice reply sent]");
          $("convHint").textContent = `Active conversation #${currentConversationId}`;

          const buf = await res.arrayBuffer();
          const blob = new Blob([buf], { type: "audio/mpeg" });
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          audio.play();

          await refreshConversations();
        } else {
          const res = await authFetch("/api/chat", {
            method: "POST",
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!data.ok) throw new Error(data.error || "chat failed");
          currentConversationId = data.conversation_id;
          setLastResult(data.reply || "");
          $("convHint").textContent = `Active conversation #${currentConversationId}`;
          await refreshConversations();
        }
        setHudStatus("Ready");
      } catch (e) {
        console.error(e);
        setHudStatus("Chat error");
        setLastResult("Error: " + e);
      }
    }

    // --- Mic / STT / Auto-listen / Wake word ---
    let mediaStream = null;
    let mediaRecorder = null;
    let chunks = [];
    let isRecording = false;
    let autoListenEnabled = false;
    let wakeWordEnabled = false;

    async function ensureMediaStream() {
      if (!mediaStream) {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
      }
    }

    function updateMicUI() {
      const btn = $("micButton");
      $("micIcon").textContent = isRecording ? "‚èπ" : "üéô";
      if (isRecording) {
        btn.classList.add("recording");
        setVoiceStatus("recording‚Ä¶");
      } else {
        btn.classList.remove("recording");
        if (!autoListenEnabled) setVoiceStatus("idle");
      }
    }

    async function startMicOnce() {
      try {
        await ensureMediaStream();
        chunks = [];
        mediaRecorder = new MediaRecorder(mediaStream);
        isRecording = true;
        updateMicUI();

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) chunks.push(e.data);
        };
        mediaRecorder.onstop = () => {
          isRecording = false;
          updateMicUI();
          const blob = new Blob(chunks, { type: "audio/webm" });
          handleRecordedBlob(blob).catch(console.error);
        };

        mediaRecorder.start();
        // safety stop at ~8s
        setTimeout(() => {
          if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
          }
        }, 8000);
      } catch (e) {
        console.error(e);
        setVoiceStatus("mic error");
      }
    }

    function stopMic() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    }

    function scheduleNextListen() {
      if (!autoListenEnabled) return;
      setTimeout(() => {
        if (autoListenEnabled && !isRecording) {
          startMicOnce().catch(console.error);
        }
      }, 600);
    }

    async function handleRecordedBlob(blob) {
      try {
        setVoiceStatus("transcribing‚Ä¶");
        const form = new FormData();
        form.append("audio", blob, "mic.webm");

        const res = await authFetch("/api/stt", {
          method: "POST",
          body: form,
        });
        const data = await res.json();
        if (!data.ok) {
          setLastResult("STT error: " + (data.error || "failed"));
          setVoiceStatus("idle");
          scheduleNextListen();
          return;
        }

        let text = (data.text || "").trim();
        if (!text) {
          setVoiceStatus("idle (no speech)");
          scheduleNextListen();
          return;
        }

        if (wakeWordEnabled) {
          const lower = text.toLowerCase();
          const phrase = "hey sara";
          const idx = lower.indexOf(phrase);
          if (idx === -1) {
            setLastResult("Wake word not detected. Heard: " + text);
            setVoiceStatus("listening for wake word");
            scheduleNextListen();
            return;
          }
          text = text.slice(idx + phrase.length).trim() || "Hello.";
        }

        setLastResult("You: " + text);
        await sendTextToSara(text, { speakPreferred: true });
        setVoiceStatus("idle");
        scheduleNextListen();
      } catch (e) {
        console.error(e);
        setLastResult("Voice error: " + e);
        setVoiceStatus("idle");
        scheduleNextListen();
      }
    }

    // --- Wiring ---
    $("toggleThemeBtn").onclick = () => {
      document.body.classList.toggle("light");
    };
    $("openDocsBtn").onclick = () => {
      window.open("/docs", "_blank");
    };
    $("openFinanceBtn").onclick = () => {
      window.open("/hud/finance.html", "_blank");
    };

    // How-to + onboarding
    const howToBtn = $("howToBtn");
    if (howToBtn) howToBtn.onclick = () => showOnboarding();

    const onboardingCloseBtn = $("onboardingCloseBtn");
    if (onboardingCloseBtn) {
      onboardingCloseBtn.onclick = () => {
        setOnboarded();
        hideOnboarding();
      };
    }

    // Editable tasks
    const addTaskBtn = $("addTaskBtn");
    if (addTaskBtn) addTaskBtn.onclick = addLocalTaskFromInput;

    const taskInput = $("taskInput");
    if (taskInput) {
      taskInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addLocalTaskFromInput();
        }
      });
    }

    const clearLocalTasksBtn = $("clearLocalTasksBtn");
    if (clearLocalTasksBtn) clearLocalTasksBtn.onclick = clearLocalTasks;

    // Budget mini
    const refreshBudgetBtn = $("refreshBudgetBtn");
    if (refreshBudgetBtn) refreshBudgetBtn.onclick = loadBudgetMini;

    const goFinanceBtn = $("goFinanceBtn");
    if (goFinanceBtn) goFinanceBtn.onclick = () => window.open("/hud/finance.html", "_blank");
    $("refreshCardBtn").onclick = loadCurrentCard;
    $("saveReflectionBtn").onclick = saveReflection;
    $("askSaraBtn").onclick = () => {
      const text = $("reflectionInput").value;
      sendTextToSara(text, { speakPreferred: true });
    };
    $("reflectionInput").addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
        e.preventDefault();
        const text = $("reflectionInput").value;
        sendTextToSara(text, { speakPreferred: true });
      }
    });

    $("newConversationBtn").onclick = newConversation;
    $("conversationSearch").addEventListener("input", renderConversationList);

    $("micButton").onclick = () => {
      if (isRecording) {
        stopMic();
      } else {
        autoListenEnabled = false;
        $("autoListenToggle").checked = false;
        startMicOnce().catch(console.error);
      }
    };

    $("autoListenToggle").onchange = (e) => {
      autoListenEnabled = e.target.checked;
      if (autoListenEnabled && !isRecording) {
        setVoiceStatus(
          wakeWordEnabled ? "auto-listen (wake word)" : "auto-listen"
        );
        startMicOnce().catch(console.error);
      } else if (!autoListenEnabled && !isRecording) {
        setVoiceStatus("idle");
      }
    };

    $("wakeWordToggle").onchange = (e) => {
      wakeWordEnabled = e.target.checked;
      if (wakeWordEnabled && autoListenEnabled) {
        setVoiceStatus("auto-listen (wake word)");
      }
    };

    $("loginBtn").onclick = login;
    $("logoutBtn").onclick = logout;

    // Initial load
    (async function init() {
      setHudStatus("Booting‚Ä¶");
      await loadCurrentCard();
      await refreshConversations();
      renderLocalTasks();
      await loadBudgetMini();

      if (!hasOnboarded()) showOnboarding();
      try {
        const stored = getStoredToken();
        if (stored) {
          setAuthToken(stored);
        } else {
          updateUserStatus();
        }
      } catch {
        updateUserStatus();
      }
      setHudStatus("Ready");
      setLastResult("_");
    })();
  </script>
</body>
</html>